{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h4 class="mb-4">Gestión de Ventas y Clientes</h4>

    <!-- Mostrar mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Pestañas -->
    <ul class="nav nav-tabs" id="ventasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button" role="tab">
                <i class="bi bi-people-fill"></i> Clientes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ventas-tab" data-bs-toggle="tab" data-bs-target="#ventas" type="button" role="tab">
                <i class="bi bi-receipt"></i> Registrar Venta
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                <i class="bi bi-clock-history"></i> Historial
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="ventasTabsContent">

        <!-- Pestaña Clientes -->
        <div class="tab-pane fade show active" id="clientes" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Lista de Clientes</h5>
                <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Nuevo Cliente
                </a>
            </div>

            {% if clientes %}
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Dirección</th>
                            <th>Correo</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in clientes %}
                        <tr>
                            <td>{{ c.id }}</td>
                            <td>{{ c.nombre }}</td>
                            <td>{{ c.telefono }}</td>
                            <td>{{ c.direccion }}</td>
                            <td>{{ c.correo }}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- Botón Registrar Venta -->
                                    <button class="btn btn-outline-primary" 
                                            onclick="seleccionarCliente('{{ c.id }}', '{{ c.nombre }}')"
                                            title="Registrar venta para este cliente">
                                        <i class="bi bi-bag-check"></i> Venta
                                    </button>
                                    
                                    <!-- Botón Editar -->
                                    <a href="{{ url_for('main.editar_cliente', id=c.id) }}" 
                                       class="btn btn-outline-warning"
                                       title="Editar cliente">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    
                                    <!-- Botón Eliminar -->
                                    <button type="button" 
                                            class="btn btn-outline-danger"
                                            onclick="confirmarEliminacion({{ c.id }}, '{{ c.nombre }}')"
                                            title="Eliminar cliente">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-people display-4"></i>
                <h5 class="mt-3">No hay clientes registrados</h5>
                <p>Comience agregando su primer cliente al sistema.</p>
                <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Agregar Primer Cliente
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Pestaña Ventas -->
        <div class="tab-pane fade" id="ventas" role="tabpanel">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Registrar Nueva Venta</h5>
                <div>
                    <span id="clienteSeleccionado" class="fw-bold text-primary me-3">Ningún cliente seleccionado</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarSeleccion()">
                        <i class="bi bi-x-circle"></i> Cambiar cliente
                    </button>
                </div>
            </div>

            <!-- Formulario de venta -->
            <form action="{{ url_for('main.nueva_venta') }}" method="POST" class="card p-3 shadow-sm bg-light" id="formVenta">
                <input type="hidden" name="cliente_id" id="cliente_id" required>
                <input type="hidden" name="detalles" id="detalles_venta" value="[]">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="tipo" class="form-label">Tipo de venta</label>
                        <select name="tipo" id="tipo" class="form-select" required>
                            <option value="Venta">Venta Normal</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="total" class="form-label">Total (S/)</label>
                        <input type="number" step="0.01" name="total" id="total" class="form-control" required readonly>
                    </div>
                </div>

                <!-- Sección de productos -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">Productos de la Venta</h6>
                    
                    <!-- Selector de productos -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="producto_select" class="form-label">Seleccionar producto</label>
                            <select id="producto_select" class="form-select">
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="cantidad_producto" class="form-label">Cantidad</label>
                            <input type="number" id="cantidad_producto" class="form-control" min="1" value="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-100" onclick="agregarProducto()">
                                <i class="bi bi-plus-circle"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <!-- Lista de productos agregados -->
                    <div class="table-responsive">
                        <table class="table table-sm" id="tablaProductos">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th width="100">Cantidad</th>
                                    <th width="120">Precio Unit.</th>
                                    <th width="120">Subtotal</th>
                                    <th width="80">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoProductos">
                                <!-- Los productos se agregarán aquí dinámicamente -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                    <td class="fw-bold" id="totalGeneral">S/. 0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="observaciones" class="form-label">Observaciones</label>
                    <textarea name="observaciones" id="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales..."></textarea>
                </div>

                <div class="text-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="limpiarFormulario()">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarVenta" disabled>
                        <i class="bi bi-save"></i> Guardar Venta
                    </button>
                </div>
            </form>
        </div>

        <!-- Pestaña Historial -->
        <div class="tab-pane fade" id="historial" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Historial de Ventas</h5>
            </div>

            {% if ventas %}
            <div class="table-responsive">
                <table class="table table-striped align-middle bg-white shadow-sm">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Total (S/)</th>
                            <th>Observaciones</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in ventas %}
                        <tr>
                            <td>{{ v.id }}</td>
                            <td>{{ v.cliente }}</td>
                            <td>{{ v.fecha }}</td>  <!-- ← CORREGIDO -->
                            <td>
                                <span class="badge {% if v.tipo == 'Contado' %}bg-success{% elif v.tipo == 'Crédito' %}bg-warning{% else %}bg-primary{% endif %}">
                                    {{ v.tipo or 'Venta' }}
                                </span>
                            </td>
                            <td class="fw-bold">S/. {{ "%.2f"|format(v.total) }}</td>
                            <td>{{ v.observaciones or '' }}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="verDetalleVenta({{ v.id }})" title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center mt-2">
                <i class="bi bi-info-circle"></i> No hay ventas registradas aún.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar cliente -->
<div class="modal fade" id="modalEliminarCliente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar al cliente <strong id="nombreClienteEliminar"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> 
                    Esta acción no se puede deshacer. Si el cliente tiene ventas registradas, no podrá ser eliminado.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="#" class="btn btn-danger" id="btnEliminarClienteConfirmar">
                    <i class="bi bi-trash"></i> Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalle de venta -->
<div class="modal fade" id="modalDetalleVenta" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Venta #{{ venta_especifica.id if venta_especifica }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if venta_especifica and detalles_venta %}
                <!-- Información de la venta -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <strong>Cliente:</strong> {{ venta_especifica.cliente }}<br>
                        <strong>Fecha:</strong> {{ venta_especifica.fecha }}
                    </div>
                    <div class="col-md-6">
                        <strong>Tipo:</strong> 
                        <span class="badge {% if venta_especifica.tipo == 'Contado' %}bg-success{% elif venta_especifica.tipo == 'Crédito' %}bg-warning{% else %}bg-primary{% endif %}">
                            {{ venta_especifica.tipo }}
                        </span><br>
                        <strong>Total:</strong> S/. {{ "%.2f"|format(venta_especifica.total) }}<br>
                        <strong>Observaciones:</strong> {{ venta_especifica.observaciones or 'Ninguna' }}
                    </div>
                </div>

                <!-- Detalles de productos -->
                <h6>Productos Vendidos</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detalle in detalles_venta %}
                            <tr>
                                <td>{{ detalle.producto }}</td>
                                <td>{{ detalle.cantidad }}</td>
                                <td>S/. {{ "%.2f"|format(detalle.precio_unitario) }}</td>
                                <td>S/. {{ "%.2f"|format(detalle.subtotal) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                <td class="fw-bold">S/. {{ "%.2f"|format(venta_especifica.total) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-exclamation-triangle text-warning display-4"></i>
                    <p class="mt-3">No se pudo cargar el detalle de la venta.</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let productosDisponibles = [];
let productosSeleccionados = [];

// Cargar productos disponibles al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarProductos();
    
    // Mostrar modal de detalle si hay una venta específica
    {% if venta_especifica %}
    const modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalleVenta'));
    modalDetalle.show();
    {% endif %}
});

// Función para cargar productos desde API
function cargarProductos() {
    fetch('/api/productos_venta')
        .then(response => response.json())
        .then(data => {
            productosDisponibles = data;
            const select = document.getElementById('producto_select');
            select.innerHTML = '<option value="">Seleccione un producto...</option>';
            
            data.forEach(producto => {
                const option = document.createElement('option');
                option.value = producto.id;
                option.textContent = `${producto.nombre} - Stock: ${producto.stock} - S/. ${producto.precio}`;
                option.setAttribute('data-precio', producto.precio);
                option.setAttribute('data-stock', producto.stock);
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar productos:', error);
        });
}

// Función para agregar producto a la venta
function agregarProducto() {
    const select = document.getElementById('producto_select');
    const cantidadInput = document.getElementById('cantidad_producto');
    const productoId = select.value;
    const cantidad = parseInt(cantidadInput.value);
    
    if (!productoId || !cantidad || cantidad <= 0) {
        alert('Por favor seleccione un producto y una cantidad válida.');
        return;
    }
    
    const producto = productosDisponibles.find(p => p.id == productoId);
    if (!producto) return;
    
    // Verificar stock
    if (cantidad > producto.stock) {
        alert(`Stock insuficiente. Disponible: ${producto.stock}`);
        return;
    }
    
    // Verificar si el producto ya está en la lista
    const existente = productosSeleccionados.findIndex(p => p.id == productoId);
    if (existente !== -1) {
        productosSeleccionados[existente].cantidad += cantidad;
    } else {
        productosSeleccionados.push({
            id: productoId,
            nombre: producto.nombre,
            precio: producto.precio,
            cantidad: cantidad
        });
    }
    
    actualizarTablaProductos();
    select.value = '';
    cantidadInput.value = 1;
}

// Función para eliminar producto de la lista
function eliminarProducto(index) {
    productosSeleccionados.splice(index, 1);
    actualizarTablaProductos();
}

// Función para actualizar la tabla de productos
// Función para actualizar la tabla de productos
function actualizarTablaProductos() {
    const tbody = document.getElementById('cuerpoProductos');
    const totalInput = document.getElementById('total');
    const totalGeneral = document.getElementById('totalGeneral');
    const btnGuardar = document.getElementById('btnGuardarVenta');
    const detallesInput = document.getElementById('detalles_venta');
    
    tbody.innerHTML = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        const subtotal = producto.precio * producto.cantidad;
        total += subtotal;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${producto.nombre}</td>
            <td>${producto.cantidad}</td>
            <td>S/. ${producto.precio.toFixed(2)}</td>
            <td>S/. ${subtotal.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarProducto(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    totalInput.value = total.toFixed(2);
    totalGeneral.textContent = `S/. ${total.toFixed(2)}`;
    
    // Habilitar/deshabilitar botón de guardar
    const clienteSeleccionado = document.getElementById('cliente_id').value;
    btnGuardar.disabled = !(clienteSeleccionado && productosSeleccionados.length > 0);
    
    // Actualizar campo hidden con los detalles - CORREGIDO
    detallesInput.value = JSON.stringify(productosSeleccionados.map(p => ({
        id_producto: p.id,  // Cambiado de producto_id a id_producto
        cantidad: p.cantidad
        // No enviar precio, se obtiene de la base de datos
    })));
}

// Función para seleccionar cliente para venta
function seleccionarCliente(id, nombre) {
    document.getElementById('cliente_id').value = id;
    document.getElementById('clienteSeleccionado').innerText = 'Cliente: ' + nombre;
    
    // Cambiar a la pestaña de ventas
    const ventasTab = new bootstrap.Tab(document.querySelector('#ventas-tab'));
    ventasTab.show();
    
    // Actualizar estado del botón de guardar
    actualizarTablaProductos();
}

// Función para limpiar selección de cliente
function limpiarSeleccion() {
    document.getElementById('cliente_id').value = '';
    document.getElementById('clienteSeleccionado').innerText = 'Ningún cliente seleccionado';
    actualizarTablaProductos();
}

// Función para limpiar formulario completo
function limpiarFormulario() {
    productosSeleccionados = [];
    document.getElementById('observaciones').value = '';
    document.getElementById('tipo').value = 'Venta';
    actualizarTablaProductos();
}

// Función para confirmar eliminación de cliente
function confirmarEliminacion(clienteId, clienteNombre) {
    document.getElementById('nombreClienteEliminar').textContent = clienteNombre;
    document.getElementById('btnEliminarClienteConfirmar').href = "{{ url_for('main.eliminar_cliente', id=0) }}".replace('0', clienteId);
    
    const modal = new bootstrap.Modal(document.getElementById('modalEliminarCliente'));
    modal.show();
}

// Función para ver detalle de venta (carga la página con parámetros)
function verDetalleVenta(ventaId) {
    window.location.href = "{{ url_for('main.ver_venta', id=0) }}".replace('0', ventaId);
}
</script>

{% endblock %}