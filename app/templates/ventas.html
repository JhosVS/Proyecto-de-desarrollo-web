{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h4 class="mb-4">Gestión de Ventas y Clientes</h4>

    <!-- Mensajes flash simplificado -->
    {% if get_flashed_messages() %}
    <div class="alert-container">
        {% for category, message in get_flashed_messages(with_categories=true) %}
        <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Pestañas principales -->
    <ul class="nav nav-tabs" id="ventasTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar" type="button" role="tab">
                <i class="bi bi-cart-plus"></i> Registrar Venta
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button" role="tab">
                <i class="bi bi-people-fill"></i> Clientes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                <i class="bi bi-clock-history"></i> Historial
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="ventasTabsContent">

        <!-- Pestaña Registrar Venta -->
        <div class="tab-pane fade show active" id="registrar" role="tabpanel">
            <div class="row">
                <!-- Columna izquierda -->
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Detalles de la Venta</h5>
                        </div>
                        <div class="card-body">
                            <!-- Selección de cliente -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6>Seleccionar Cliente</h6>
                                    <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-person-plus"></i> Nuevo Cliente
                                    </a>
                                </div>
                                
                                <div class="input-group">
                                    <select class="form-select" id="cliente_select">
                                        <option value="">Seleccione un cliente...</option>
                                        {% for c in clientes %}
                                        <option value="{{ c.id }}" data-nombre="{{ c.nombre }}">{{ c.nombre }} - {{ c.telefono }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="btnLimpiarCliente">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <span id="clienteSeleccionado" class="fw-bold text-primary">Ningún cliente seleccionado</span>
                                </div>
                            </div>

                            <!-- Selección de productos -->
                            <div class="mb-3">
                                <h6>Agregar Productos</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <select id="producto_select" class="form-select">
                                            <option value="">Seleccione un producto...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" id="cantidad_producto" class="form-control" min="1" value="1">
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-primary w-100" id="btnAgregarProducto">
                                            <i class="bi bi-plus-circle"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Lista de productos -->
                            <div class="table-responsive">
                                <table class="table table-sm" id="tablaProductos">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th width="100">Cantidad</th>
                                            <th width="120">Precio Unit.</th>
                                            <th width="120">Subtotal</th>
                                            <th width="80">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoProductos"></tbody>
                                    <tfoot>
                                        <tr class="table-active">
                                            <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                            <td class="fw-bold" id="totalGeneral">S/. 0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha -->
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Resumen y Finalización</h6>
                        </div>
                        <div class="card-body">
                            <form action="{{ url_for('main.nueva_venta') }}" method="POST" id="formVenta">
                                <input type="hidden" name="cliente_id" id="cliente_id">
                                <input type="hidden" name="detalles" id="detalles_venta" value="[]">
                                
                                <div class="mb-3">
                                    <label for="total" class="form-label">Total (S/)</label>
                                    <input type="number" step="0.01" name="total" id="total" class="form-control" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="observaciones" class="form-label">Observaciones</label>
                                    <textarea name="observaciones" id="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales..."></textarea>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary" id="btnGuardarVenta" disabled>
                                        <i class="bi bi-save"></i> Guardar Venta
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btnLimpiarTodo">
                                        <i class="bi bi-arrow-clockwise"></i> Limpiar Todo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña Clientes -->
        <div class="tab-pane fade" id="clientes" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Lista de Clientes</h5>
                <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Nuevo Cliente
                </a>
            </div>

            {% if clientes %}
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Dirección</th>
                            <th>Correo</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in clientes %}
                        <tr>
                            <td>{{ c.id }}</td>
                            <td>{{ c.nombre }}</td>
                            <td>{{ c.telefono }}</td>
                            <td>{{ c.direccion }}</td>
                            <td>{{ c.correo }}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-usar-cliente" 
                                            data-id="{{ c.id }}" 
                                            data-nombre="{{ c.nombre }}">
                                        <i class="bi bi-cart"></i> Venta
                                    </button>
                                    <a href="{{ url_for('main.editar_cliente', id=c.id) }}" 
                                       class="btn btn-outline-warning">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <button class="btn btn-outline-danger btn-eliminar-cliente"
                                            data-id="{{ c.id }}"
                                            data-nombre="{{ c.nombre }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-people display-4"></i>
                <h5 class="mt-3">No hay clientes registrados</h5>
                <a href="{{ url_for('main.nuevo_cliente') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Agregar Cliente
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Pestaña Historial -->
        <div class="tab-pane fade" id="historial" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Historial de Ventas</h5>
            </div>

            {% if ventas %}
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Total (S/)</th>
                            <th>Observaciones</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in ventas %}
                        <tr>
                            <td>{{ v.id }}</td>
                            <td>{{ v.cliente }}</td>
                            <td>{{ v.fecha }}</td>
                            <td>
                                <span class="badge {% if v.tipo == 'Contado' %}bg-success{% elif v.tipo == 'Crédito' %}bg-warning{% else %}bg-primary{% endif %}">
                                    {{ v.tipo or 'Venta' }}
                                </span>
                            </td>
                            <td class="fw-bold">S/. {{ "%.2f"|format(v.total) }}</td>
                            <td>{{ v.observaciones or 'Sin observaciones' }}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info btn-ver-detalle" data-id="{{ v.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-generar-pdf" data-id="{{ v.id }}">
                                        <i class="bi bi-file-earmark-pdf"></i> Boleta
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay ventas registradas aún.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modales -->
<div class="modal fade" id="modalEliminarCliente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar al cliente <strong id="nombreClienteEliminar"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> 
                    Esta acción no se puede deshacer. Si el cliente tiene ventas registradas, no podrá ser eliminado.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="#" class="btn btn-danger" id="btnEliminarClienteConfirmar">
                    <i class="bi bi-trash"></i> Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalle de venta (MEJORADO) -->
<div class="modal fade" id="modalDetalleVenta" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Venta #<span id="ventaIdTitulo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleVentaContenido">
                    <!-- Cargado dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="btnGenerarPDFModal">
                    <i class="bi bi-file-earmark-pdf"></i> Generar Boleta PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ========== CONFIGURACIÓN INICIAL ==========
document.addEventListener('DOMContentLoaded', function() {
    VentaApp.init();
    
    // Mostrar modal de detalle si se cargó con una venta específica
    {% if venta_especifica and detalles_venta %}
    VentaApp.mostrarDetalleVenta({{ venta_especifica|tojson }}, {{ detalles_venta|tojson }});
    {% endif %}
});

// ========== OBJETO PRINCIPAL ==========
const VentaApp = {
    productos: [],
    carrito: [],
    ventaActual: null,
    
    init: function() {
        this.cargarProductos();
        this.inicializarEventos();
    },
    
    cargarProductos: async function() {
        try {
            const response = await fetch('/api/productos_venta');
            this.productos = await response.json();
            this.actualizarSelectProductos();
        } catch (error) {
            console.error('Error al cargar productos:', error);
            this.mostrarAlerta('Error al cargar productos', 'danger');
        }
    },
    
    actualizarSelectProductos: function() {
        const select = document.getElementById('producto_select');
        if (!select) return;
        
        select.innerHTML = '<option value="">Seleccione un producto...</option>';
        
        this.productos.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.nombre} - Stock: ${p.stock} - S/. ${p.precio}`;
            option.dataset.precio = p.precio;
            option.dataset.stock = p.stock;
            select.appendChild(option);
        });
    },
    
    inicializarEventos: function() {
        // Eventos de cliente
        const clienteSelect = document.getElementById('cliente_select');
        const btnLimpiarCliente = document.getElementById('btnLimpiarCliente');
        if (clienteSelect) clienteSelect.addEventListener('change', this.seleccionarCliente.bind(this));
        if (btnLimpiarCliente) btnLimpiarCliente.addEventListener('click', this.limpiarCliente.bind(this));
        
        // Eventos de productos
        const btnAgregarProducto = document.getElementById('btnAgregarProducto');
        const btnLimpiarTodo = document.getElementById('btnLimpiarTodo');
        if (btnAgregarProducto) btnAgregarProducto.addEventListener('click', this.agregarProducto.bind(this));
        if (btnLimpiarTodo) btnLimpiarTodo.addEventListener('click', this.limpiarTodo.bind(this));
        
        // Evento para generar PDF desde el modal
        const btnGenerarPDFModal = document.getElementById('btnGenerarPDFModal');
        if (btnGenerarPDFModal) {
            btnGenerarPDFModal.addEventListener('click', () => {
                if (this.ventaActual) {
                    this.generarPDF(this.ventaActual.id);
                }
            });
        }
        
        // Eventos delegados para tablas
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            if (btn.classList.contains('btn-usar-cliente')) {
                this.usarCliente(btn.dataset.id, btn.dataset.nombre);
            }
            else if (btn.classList.contains('btn-eliminar-cliente')) {
                this.confirmarEliminarCliente(btn.dataset.id, btn.dataset.nombre);
            }
            else if (btn.classList.contains('btn-ver-detalle')) {
                this.cargarDetalleVenta(btn.dataset.id);
            }
            else if (btn.classList.contains('btn-generar-pdf')) {
                this.generarPDF(btn.dataset.id);
            }
            else if (btn.closest('#cuerpoProductos') && btn.classList.contains('btn-eliminar-producto')) {
                const index = btn.dataset.index;
                this.eliminarProducto(index);
            }
        });
    },
    
    // ========== FUNCIONALIDADES DE CLIENTE ==========
    seleccionarCliente: function() {
        const select = document.getElementById('cliente_select');
        const option = select.options[select.selectedIndex];
        
        if (option.value) {
            document.getElementById('cliente_id').value = option.value;
            document.getElementById('clienteSeleccionado').textContent = 'Cliente: ' + option.dataset.nombre;
            this.actualizarBotonGuardar();
        } else {
            this.limpiarCliente();
        }
    },
    
    limpiarCliente: function() {
        document.getElementById('cliente_id').value = '';
        document.getElementById('clienteSeleccionado').textContent = 'Ningún cliente seleccionado';
        document.getElementById('cliente_select').value = '';
        this.actualizarBotonGuardar();
    },
    
    usarCliente: function(id, nombre) {
        document.getElementById('cliente_id').value = id;
        document.getElementById('clienteSeleccionado').textContent = 'Cliente: ' + nombre;
        document.getElementById('cliente_select').value = id;
        
        // Cambiar a pestaña de registrar venta
        new bootstrap.Tab(document.querySelector('#registrar-tab')).show();
        this.actualizarBotonGuardar();
    },
    
    confirmarEliminarCliente: function(id, nombre) {
        document.getElementById('nombreClienteEliminar').textContent = nombre;
        document.getElementById('btnEliminarClienteConfirmar').href = 
            "{{ url_for('main.eliminar_cliente', id=0) }}".replace('0', id);
        
        new bootstrap.Modal(document.getElementById('modalEliminarCliente')).show();
    },
    
    // ========== FUNCIONALIDADES DE PRODUCTOS ==========
    agregarProducto: function() {
        const select = document.getElementById('producto_select');
        const cantidadInput = document.getElementById('cantidad_producto');
        const productoId = select.value;
        const cantidad = parseInt(cantidadInput.value);
        
        if (!productoId || !cantidad || cantidad <= 0) {
            this.mostrarAlerta('Por favor seleccione un producto y una cantidad válida.', 'warning');
            return;
        }
        
        const producto = this.productos.find(p => p.id == productoId);
        if (!producto) return;
        
        if (cantidad > producto.stock) {
            this.mostrarAlerta(`Stock insuficiente. Disponible: ${producto.stock}`, 'warning');
            return;
        }
        
        // Agregar o actualizar en carrito
        const index = this.carrito.findIndex(p => p.id == productoId);
        if (index !== -1) {
            this.carrito[index].cantidad += cantidad;
        } else {
            this.carrito.push({
                id: productoId,
                nombre: producto.nombre,
                precio: producto.precio,
                cantidad: cantidad
            });
        }
        
        this.actualizarTablaProductos();
        select.value = '';
        cantidadInput.value = 1;
    },
    
    eliminarProducto: function(index) {
        this.carrito.splice(index, 1);
        this.actualizarTablaProductos();
    },
    
    actualizarTablaProductos: function() {
        const tbody = document.getElementById('cuerpoProductos');
        const totalInput = document.getElementById('total');
        const totalGeneral = document.getElementById('totalGeneral');
        const detallesInput = document.getElementById('detalles_venta');
        
        if (!tbody) return;
        
        tbody.innerHTML = '';
        let total = 0;
        
        this.carrito.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            total += subtotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${producto.nombre}</td>
                <td>${producto.cantidad}</td>
                <td>S/. ${producto.precio.toFixed(2)}</td>
                <td>S/. ${subtotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-outline-danger btn-sm btn-eliminar-producto" data-index="${index}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        if (totalInput) totalInput.value = total.toFixed(2);
        if (totalGeneral) totalGeneral.textContent = `S/. ${total.toFixed(2)}`;
        
        if (detallesInput) {
            detallesInput.value = JSON.stringify(
                this.carrito.map(p => ({ id_producto: p.id, cantidad: p.cantidad }))
            );
        }
        
        this.actualizarBotonGuardar();
    },
    
    actualizarBotonGuardar: function() {
        const btn = document.getElementById('btnGuardarVenta');
        if (!btn) return;
        
        const clienteSeleccionado = document.getElementById('cliente_id').value;
        btn.disabled = !(clienteSeleccionado && this.carrito.length > 0);
    },
    
    limpiarTodo: function() {
        this.carrito = [];
        const observaciones = document.getElementById('observaciones');
        if (observaciones) observaciones.value = '';
        this.limpiarCliente();
        this.actualizarTablaProductos();
    },
    
    // ========== FUNCIONALIDADES DE VENTAS ==========
    cargarDetalleVenta: async function(id) {
        try {
            this.mostrarCargando('Cargando detalle de venta...');
            const response = await fetch(`/api/ventas/${id}/detalle`);
            
            if (!response.ok) {
                // Si no hay API, redirigir a la página de detalle como en el original
                window.location.href = "{{ url_for('main.ver_venta', id=0) }}".replace('0', id);
                return;
            }
            
            const data = await response.json();
            this.ocultarCargando();
            this.mostrarDetalleVenta(data.venta, data.detalles);
        } catch (error) {
            this.ocultarCargando();
            // Fallback a la redirección original
            window.location.href = "{{ url_for('main.ver_venta', id=0) }}".replace('0', id);
        }
    },
    
    mostrarDetalleVenta: function(venta, detalles) {
        this.ventaActual = venta;
        
        // Actualizar título
        document.getElementById('ventaIdTitulo').textContent = venta.id;
        
        // Crear contenido del modal
        let contenido = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <strong>Cliente:</strong> ${venta.cliente}<br>
                    <strong>Fecha:</strong> ${venta.fecha}
                </div>
                <div class="col-md-6">
                    <strong>Tipo:</strong> 
                    <span class="badge ${venta.tipo === 'Contado' ? 'bg-success' : venta.tipo === 'Crédito' ? 'bg-warning' : 'bg-primary'}">
                        ${venta.tipo || 'Venta'}
                    </span><br>
                    <strong>Total:</strong> S/. ${venta.total.toFixed(2)}<br>
                    <strong>Observaciones:</strong> ${venta.observaciones || 'Ninguna'}
                </div>
            </div>

            <h6>Productos Vendidos</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Agregar detalles de productos
        detalles.forEach(detalle => {
            contenido += `
                <tr>
                    <td>${detalle.producto}</td>
                    <td>${detalle.cantidad}</td>
                    <td>S/. ${detalle.precio_unitario.toFixed(2)}</td>
                    <td>S/. ${detalle.subtotal.toFixed(2)}</td>
                </tr>
            `;
        });
        
        contenido += `
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                            <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                            <td class="fw-bold">S/. ${venta.total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
        
        // Insertar contenido en el modal
        document.getElementById('detalleVentaContenido').innerHTML = contenido;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalleVenta'));
        modal.show();
    },
    
    generarPDF: async function(id) {
        try {
            this.mostrarCargando('Generando boleta...');
            const response = await fetch(`/api/ventas/${id}/pdf/boleta`);
            
            if (!response.ok) throw new Error('Error al generar boleta');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `boleta_venta_${id}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            this.ocultarCargando();
            this.mostrarAlerta('Boleta generada correctamente', 'success');
        } catch (error) {
            this.ocultarCargando();
            this.mostrarAlerta('Error al generar boleta: ' + error.message, 'danger');
        }
    },
    
    // ========== UTILIDADES ==========
    mostrarAlerta: function(mensaje, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show mt-2`;
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.alert-container') || document.querySelector('.container');
        if (container) {
            container.prepend(alertDiv);
        }
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    },
    
    mostrarCargando: function(mensaje) {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            overlay.style.zIndex = '9999';
            overlay.innerHTML = `
                <div class="bg-white rounded p-4 text-center">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p class="mb-0">${mensaje}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
    },
    
    ocultarCargando: function() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.remove();
    }
};
</script>

<style>
/* Estilos mínimos necesarios */
.btn-group-sm .btn { padding: 0.25rem 0.5rem; }
.badge { font-size: 0.75em; }
.modal-lg { max-width: 800px; }
.table tbody tr:hover { background-color: rgba(0,0,0,0.02); }
</style>

{% endblock %}